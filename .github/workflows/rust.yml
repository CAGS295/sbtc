name: Rust

on:
  pull_request:
    branches: [ "master", "20-introduce-ci", "20-temporary-ci"] # We should make this main or mainline.
    paths-ignore: ['**.md']

env:
  CARGO_TERM_COLOR: always

jobs:
  generate-lockfile:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Build
      run: cargo generate-lockfile -v
    - uses: actions/upload-artifact@v3
      with:
        name: Cargo.lock
        path: Cargo.lock

  pr-validation:
    needs: generate-lockfile
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/download-artifact@v3
      with:
        name: Cargo.lock

    # TODO: All steps following this one are made to be temporary. They will be
    # replaced with calls to a locally runnable task runner script so that local
    # testing and github actions are one-to-one.
    #
    # Task-Runner Script conversation:
    # https://github.com/stacks-network/stacks-blockchain/issues/3844
    - name: Install Build Dependencies
      run: >
        cargo install cargo-llvm-cov &&
        rustup component add clippy-preview &&
        rustup component add rustfmt

    - name: Lint
      run: >
        cargo fmt --check --verbose &&
        cargo clippy -- -D warnings -W clippy::all

    # This command will create a single code coverage report for the whole workspace.
    # In the future we'll want to create a separate coverage report for each project
    # within the workspace so we can create a codecov flag for each one.
    #
    # Codecov docs:
    # https://docs.codecov.com/docs/flags#one-to-one-relationship-of-flags-to-uploads
    - name: Test with Coverage
      run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

    # We'll want to add flags to track the test coverage delta in pull requests.
    #
    # Flag usage:
    # https://docs.codecov.com/docs/flags
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./lcov.info
        fail_ci_if_error: true
